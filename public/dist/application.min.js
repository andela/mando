"use strict";var ApplicationConfiguration=function(){var applicationModuleName="andonation",applicationModuleVendorDependencies=["ngResource","toaster","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","youtube-embed"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("banker"),ApplicationConfiguration.registerModule("campaign"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("users"),angular.module("banker").config(["$stateProvider",function($stateProvider){$stateProvider.state("bank",{url:"/bank",templateUrl:"modules/banker/views/bankers.client.view.html"})}]),angular.module("banker").controller("transactionCtrl",["$scope","Authentication","$http","$timeout","toaster","bankerConstant","$modal","bankerFactory",function($scope,Authentication,$http,$timeout,toaster,bankerConstant,$modal,bankerFactory){$scope.reports=[],$scope.withdrawal={},$scope.balance={bank_id:bankerConstant.BANK_ID,amount:""},$scope.authentication=Authentication,$scope.getBalance=function(){var date=(new Date).toISOString();bankerFactory.getSystemBalance($scope.balance.bank_id).balance({description:"USD",at:date},function(error,apiRes){if(error)return console.log("im here"),void toaster.pop("error","An Error Occurred"+error);var amount=parseInt(apiRes.balance.value.amount);$scope.balance.amount=amount})},$scope.getBalance(),$scope.getJournals=function(){bankerFactory.getJournalReports($scope.balance.bank_id).get({description:"USD",action:"before",effective_at:(new Date).toISOString()},function(error,apiRes){if(error)return error;for(var i=0;i<apiRes.posted_lines.length;i++)try{var stringToObj=JSON.parse(apiRes.posted_lines[i].description);apiRes.posted_lines[i].description=stringToObj}catch(e){apiRes.posted_lines[i].description={name:"anonymous",description:apiRes.posted_lines[i].description}}$scope.journal=apiRes.posted_lines,$scope.$digest()})},$scope.getJournals(),$scope.withdrawFromBank=function(amount){var userToString={name:$scope.authentication.user.displayName,email:$scope.authentication.user.email,description:"Cash Withdrawal"},userdetails=JSON.stringify(userToString);bankerFactory.createAndPostTransaction().createAndPost({effective_at:(new Date).toISOString(),description:userdetails,reference:"http://andonation-mando.herokuapp.com/bank",lines:[{account:$scope.balance.bank_id,description:userdetails,reference:"http://andonation-mando.herokuapp.com/bank",value:{type:"debit",amount:amount}},{account:bankerConstant.SYSTEM_ID,description:"Cash Deposit",reference:"http://andonation-mando.herokuapp.com/bank",value:{type:"credit",amount:amount}}]},function(error,apiRes){if(error)return error;JSON.parse(apiRes.posting_journal_entry.description);$scope.getBalance(),$scope.getJournals()})},$scope.depositIntoBank=function(amount){var userToString={name:$scope.authentication.user.displayName,email:$scope.authentication.user.email,description:"Cash Deposit"},userdetails=JSON.stringify(userToString);bankerFactory.createAndPostTransaction().createAndPost({effective_at:(new Date).toISOString(),description:userdetails,reference:"http://andonation-mando.herokuapp.com/bank",lines:[{account:$scope.balance.bank_id,description:userdetails,reference:"http://andonation-mando.herokuapp.com/bank",value:{type:"credit",amount:amount}},{account:bankerConstant.SYSTEM_ID,description:"cash deposit",reference:"http://andonation-mando.herokuapp.com/bank",value:{type:"debit",amount:amount}}]},function(error){return error?error:($scope.getBalance(),void $scope.getJournals())})},$scope.openModalWithdraw=function(size){var modalInstance=$modal.open({templateUrl:"modules/banker/views/withdraw.modal.view.html",controller:"modalInstanceCtrl",size:size,resolve:{transaction:function(){return $scope.withdraw}}});modalInstance.result.then(function(amount){$scope.withdrawFromBank(amount),toaster.pop("success","Transaction Completed")})},$scope.openModalDeposit=function(size){var modalInstance=$modal.open({templateUrl:"modules/banker/views/deposit.modal.view.html",controller:"modalInstanceCtrl",size:size,resolve:{transaction:function(){return $scope.deposit}}});modalInstance.result.then(function(amount){$scope.depositIntoBank(amount),toaster.pop("success","Transaction Completed")})}}]),angular.module("banker").controller("modalInstanceCtrl",["$scope","$modalInstance","transaction",function($scope,$modalInstance){$scope.ok=function(transaction){$modalInstance.close(transaction.amount)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("banker").constant("bankerConstant",{BANK_ID:"6HNEAjoyxWtXjVXD2TyZqE",SYSTEM_ID:"E8GtyKhrPjSduG8aHSUusc"}).factory("bankerFactory",[function(){var subledger=new Subledger,org_id="EpXxbhcVpxyC8BH0icuIQF",book_id="R6WkhSAmw4STDyGHbrrFJL";subledger.setCredentials("2lzQysbyNXhPgYxx8pp2vE","CJzZPwRw01thgquyeD6RYc");var getSystemBalance=function(account_id){return subledger.organization(org_id).book(book_id).account(account_id)},createAndPostTransaction=function(){return subledger.organization(org_id).book(book_id).journalEntry()},getJournalReports=function(account_id){return subledger.organization(org_id).book(book_id).account(account_id).line()};return{getSystemBalance:getSystemBalance,createAndPostTransaction:createAndPostTransaction,getJournalReports:getJournalReports}}]),angular.module("campaign").config(["$stateProvider","datepickerConfig","$sceDelegateProvider",function($stateProvider,datepickerConfig,$sceDelegateProvider){datepickerConfig.startingDay="1",$stateProvider.state("addCampaign",{url:"/campaign/add",templateUrl:"modules/campaigns/views/addCampaign.client.view.html"}).state("editCampaign",{url:"/campaign/:campaignTimestamp/:campaignslug/edit",templateUrl:"modules/campaigns/views/editCampaign.client.view.html"}).state("viewCampaign",{url:"/campaign/:campaignTimeStamp/:campaignslug",templateUrl:"modules/campaigns/views/viewCampaign.client.view.html"}).state("allCampaigns",{url:"/campaigns",templateUrl:"modules/campaigns/views/allCampaigns.client.view.html"}).state("userCampaigns",{url:"/campaigns/myAndonation",templateUrl:"modules/campaigns/views/userCampaigns.client.view.html"}),$sceDelegateProvider.resourceUrlWhitelist(["**"])}]),angular.module("campaign").controller("addCampaignCtrl",["$scope","toaster","backendService","$location","Authentication","youtubeEmbedUtils",function($scope,toaster,backendService,$location,Authentication,youtubeEmbedUtils){$scope.authentication=Authentication,$scope.campaign={},$scope.minDate=moment().add(1,"days"),$scope.maxDate=moment().add(30,"days"),$scope.authentication.user||$location.path("/"),$scope.addCampaign=function(){$scope.campaign.youtubeUrl=youtubeEmbedUtils.getIdFromURL($scope.campaign.youtubeUrl),backendService.addCampaign($scope.campaign).success(function(data){toaster.pop("success",$scope.campaign.title,"Campaign created successfully"),$location.path("/campaign/"+data.slug)}).error(function(error){$scope.error=error})},$scope.validateYoutubeUrl=function(url,isValid){if(!isValid)return void($scope.youtubeError="Please enter a valid youtube Url");var youtubeId=youtubeEmbedUtils.getIdFromURL(url);return youtubeId===url?void($scope.youtubeError="Please enter a valid youtube URL"):void backendService.checkYouTubeUrl(youtubeId).success(function(){$scope.youtubeError=""}).error(function(error){$scope.youtubeError=error})},$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0}}]),angular.module("campaign").controller("allCampaignCtrl",["$scope","$location","backendService",function($scope,$location,backendService){$scope.Campaigns=[],$scope.criteria="created",$scope.currentPage=1,$scope.itemsPerPage=21,$scope.totalItems=1,$scope.init=function(){backendService.getCampaigns().success(function(data){$scope.campaigns=data,$scope.totalItems=data.length,$scope.filterCampaigns()}).error(function(error){return error})},$scope.filterCampaigns=function(){var begin=($scope.currentPage-1)*$scope.itemsPerPage,end=begin+$scope.itemsPerPage;$scope.startItems=begin+1,$scope.endItems=end<$scope.totalItems?end:$scope.totalItems,$scope.Campaigns=$scope.campaigns.slice(begin,end)},$scope.pageChanged=function(){$scope.filterCampaigns()},$scope.init()}]),angular.module("campaign").controller("editCampaignCtrl",["$scope","toaster","backendService","$location","Authentication","$stateParams","youtubeEmbedUtils",function($scope,toaster,backendService,$location,Authentication,$stateParams,youtubeEmbedUtils){$scope.authentication=Authentication,$scope.authentication.user||$location.path("/"),backendService.getCampaign($stateParams.campaignTimestamp+"/"+$stateParams.campaignslug).success(function(data){$scope.authentication.user._id!==data.createdBy._id&&$location.path("/campaign/"+data.slug),$scope.minDate=moment(data.created),$scope.maxDate=moment(data.created).add(30,"days"),$scope.campaign=data,$scope.campaign.youtubeUrl="https://www.youtube.com/watch?v="+data.youtubeUrl}).error(function(err){toaster.pop("error","An Error Occurred"+err)}),$scope.editCampaign=function(){delete $scope.campaign.createdBy,delete $scope.campaign.created,$scope.campaign.youtubeUrl=youtubeEmbedUtils.getIdFromURL($scope.campaign.youtubeUrl),backendService.updateCampaign($scope.campaign).success(function(data){toaster.pop("success","Campaign Edited Successfully"),$location.path("/campaign/"+data.slug)}).error(function(err){$scope.error=err,toaster.pop("error","An Error Occurred:"+err)})},$scope.validateYoutubeUrl=function(url){var youtubeId=youtubeEmbedUtils.getIdFromURL(url);return youtubeId===url?void($scope.youtubeError="Please enter a valid youtube URL"):void backendService.checkYouTubeUrl(youtubeId).success(function(){$scope.youtubeError=""}).error(function(error){$scope.youtubeError=error})},$scope.deleteCampaign=function(){var confirmMsg=confirm("Do you want to delete this Campaign?");confirmMsg&&backendService.deleteCampaign($scope.campaign._id).success(function(){toaster.pop("success",$scope.campaign.title,"Campaign deleted successfully"),$location.path("/campaigns/myAndonation")}).error(function(){})},$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0}}]),angular.module("campaign").controller("userCampaignsCtrl",["$scope","backendService","toaster","$location","bankerFactory","bankerConstant","Authentication","$stateParams",function($scope,backendService,toaster,$location,bankerFactory,bankerConstant,Authentication){$scope.myCampaigns=[],$scope.balance={},$scope.authentication=Authentication,$scope.authentication.user||$location.path("/");var userid=$scope.authentication.user._id;backendService.getUserCampaigns(userid).success(function(myCampaigns){$scope.myCampaigns=myCampaigns}).error(function(){$location.path("/")});var account_id=bankerConstant.BANK_ID;bankerFactory.getSystemBalance(account_id).balance({description:"USD"},function(error,apiRes){if(error)return void toaster.pop("error","An Error Occurred"+error);var amount=parseInt(apiRes.balance.value.amount);$scope.balance.amount=amount,$scope.$digest()}),$scope.limit=4,$scope.increment=function(){var campaignLength=$scope.myCampaigns.length;$scope.limit=campaignLength},$scope.decrement=function(){$scope.limit=4}}]),angular.module("campaign").controller("viewCampaignCtrl",["$scope","toaster","backendService","$location","Authentication","$stateParams",function($scope,toaster,backendService,$location,Authentication,$stateParams){$scope.authentication=Authentication,backendService.getCampaign($stateParams.campaignTimeStamp+"/"+$stateParams.campaignslug).success(function(data){console.log(data),$scope.campaign=data}).error(function(error){console.log(error),$location.path("/")})}]),angular.module("campaign").factory("backendService",["$http",function($http){var addCampaign=function(campaignData){return $http.post("/campaign/add",campaignData)},getCampaign=function(campaignid){return $http.get("/campaign/"+campaignid)},deleteCampaign=function(campaignid){return $http["delete"]("/campaign/"+campaignid)},checkYouTubeUrl=function(videoId){return $http.get("//gdata.youtube.com/feeds/api/videos/"+videoId+"?alt=json")},getUserCampaigns=function(userid){return $http.get("/campaigns/"+userid)},getCampaigns=function(){return $http.get("/campaigns")},updateCampaign=function(campaignData){return $http.put("/campaign/"+campaignData._id+"/edit",campaignData)};return{addCampaign:addCampaign,getCampaign:getCampaign,checkYouTubeUrl:checkYouTubeUrl,getUserCampaigns:getUserCampaigns,updateCampaign:updateCampaign,deleteCampaign:deleteCampaign,getCampaigns:getCampaigns}}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication",function($scope,Authentication){$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1})}]),angular.module("core").controller("HomeController",["$scope","Authentication","backendService",function($scope,Authentication,backendService){$scope.authentication=Authentication,$scope.campaigns=[],backendService.getCampaigns().success(function(data){$scope.campaigns=data}).error(function(error){$scope.error=error})}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("/");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]);