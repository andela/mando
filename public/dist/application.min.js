"use strict";var ApplicationConfiguration=function(){var applicationModuleName="andonation",applicationModuleVendorDependencies=["ngResource","toaster","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","youtube-embed","ngLodash"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("admin"),ApplicationConfiguration.registerModule("banker"),ApplicationConfiguration.registerModule("campaign"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("users"),angular.module("admin").config(["$stateProvider",function($stateProvider){$stateProvider.state("allUsers",{url:"/admin/users",templateUrl:"modules/admin/views/users.admin.client.view.html"})}]),angular.module("admin").controller("ModalInstanceCtrl",["$scope","adminBackendService","$modalInstance","roles","len","$timeout",function($scope,adminBackendService,$modalInstance,roles,len,$timeout){$scope.NoOfUser=len,adminBackendService.getRoles().success(function(data){if($scope.roles=data,1===len)for(var i=0;i<roles.length;i++)for(var j=0;j<$scope.roles.length;j++)roles[i].roleType===$scope.roles[j].roleType&&(roles[i].isAdmin===!0&&($scope.roles[j].isAdmin=roles[i].isAdmin),$scope.roles[j].count=roles[i].count,$scope.roles[j].checked=!0);else for(var x=0;x<roles.length;x++)for(var y=0;y<$scope.roles.length;y++)roles[x].roleType===$scope.roles[y].roleType&&(roles[x].isAdmin===!0&&($scope.roles[y].isAdmin=roles[x].isAdmin),$scope.roles[y].count=roles[x].count,$scope.roles[y].checked=$scope.roles[y].count<len?"indeterminate":!0)}).error(function(){}),$scope.disableSaveButton=function(isAdmin,checkStatus){$timeout(function(){"indeterminate"!==checkStatus&&($scope.disable=isAdmin&&checkStatus)},100)},$scope.ok=function(){$modalInstance.close($scope.roles)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("admin").controller("adminUserCtrl",["$scope","Authentication","adminBackendService","$location","lodash","$state","$modal","toaster","$timeout",function($scope,Authentication,adminBackendService,$location,lodash,$state,$modal,toaster,$timeout){$scope.authentication=Authentication,$scope.authentication.user||$location.path("/"),lodash.findWhere(Authentication.user.roles,{roleType:"admin"})||$state.go("userCampaigns"),adminBackendService.getUsers().success(function(data){$scope.users=data;for(var i=0;i<$scope.users.length;i++)$scope.users[i].checked=!1}).error(function(error){$scope.error=error}),$scope.noChecked=!0,$scope.check=function(){$timeout(function(){for(var count=0,i=0;i<$scope.users.length;i++)$scope.users[i].checked&&count++;$scope.noChecked=0===count,$scope.allChecked=count===$scope.users.length},100)},$scope.checkAll=function(){$timeout(function(){if($scope.allChecked){for(var i=0;i<$scope.users.length;i++)$scope.users[i].checked=!0;$scope.noChecked=!1}else{for(var j=0;j<$scope.users.length;j++)$scope.users[j].checked=!1;$scope.noChecked=!0}},100)},$scope.openModal=function(){var roles=[],NoOfCheckedUsers=0;angular.forEach($scope.users,function(user){if(user.checked){NoOfCheckedUsers++;for(var i=0;i<user.roles.length;i++)if(NoOfCheckedUsers>1)if(lodash.findWhere(roles,{roleType:user.roles[i].roleType})){var temp=lodash.findWhere(roles,{roleType:user.roles[i].roleType});temp.count++}else"admin"===user.roles[i].roleType&&user._id===$scope.authentication.user._id&&(user.roles[i].isAdmin=!0),user.roles[i].count=1,roles.push(user.roles[i]);else"admin"===user.roles[i].roleType&&user._id===$scope.authentication.user._id&&(user.roles[i].isAdmin=!0),user.roles[i].count=1,roles.push(user.roles[i])}});var modalInstance=$modal.open({templateUrl:"modules/admin/views/updateRoles.admin.modal.client.view.html",controller:"ModalInstanceCtrl",size:"sm",resolve:{roles:function(){return roles},len:function(){return NoOfCheckedUsers}}});modalInstance.result.then(function(roles){var data={};data.roles=[];var addRoles={addRoles:[]},rmRoles={rmRoles:[]};data.usersid=[],angular.forEach($scope.users,function(user){user.checked&&data.usersid.push(user._id)});for(var y=0;y<roles.length;y++)roles[y].checked===!0?addRoles.addRoles.push(roles[y]._id):roles[y].checked===!1&&rmRoles.rmRoles.push(roles[y]._id);data.roles.push(addRoles),data.roles.push(rmRoles),adminBackendService.updateUserRoles(data).success(function(data){$scope.users=data,$scope.allChecked=!1,$scope.noChecked=!0,toaster.pop("success","User Roles updated successfully")}).error(function(){toaster.pop("error","Error Occured, Please try again or contact the Admin")})})}}]),angular.module("campaign").factory("adminBackendService",["$http",function($http){var getUsers=function(){return $http.get("/admin/users")},getRoles=function(){return $http.get("/admin/roles")},updateUserRoles=function(data){return $http.put("/admin/user/roles/edit",data)};return{getUsers:getUsers,updateUserRoles:updateUserRoles,getRoles:getRoles}}]),angular.module("banker").config(["$stateProvider",function($stateProvider){$stateProvider.state("bank",{resolve:{credentials:["$http",function($http){return $http.get("/bank/credentials")}]},url:"/bank",controller:"transactionCtrl",templateUrl:"modules/banker/views/bankers.client.view.html"})}]),angular.module("banker").controller("transactionCtrl",["$scope","Authentication","$http","$timeout","toaster","$modal","bankerFactory","lodash","credentials",function($scope,Authentication,$http,$timeout,toaster,$modal,bankerFactory,lodash,credentials){$scope.reports=[],$scope.withdrawal={},$scope.balance={amount:""},$scope.isBanker=lodash.findWhere(Authentication.user.roles,{roleType:"banker"});var cred=credentials.data;bankerFactory.setCredentials(cred.key_id,cred.secret_id),$scope.authentication=Authentication,$scope.getBalance=function(){var date=(new Date).toISOString();bankerFactory.getSystemBalance(cred.org_id,cred.book_id,cred.bank_id).balance({description:"USD",at:date},function(error,apiRes){if(error)return void toaster.pop("error","An Error Occurred"+error);var amount=parseInt(apiRes.balance.value.amount);$scope.balance.amount=amount})},$scope.getBalance(),$scope.getJournals=function(cb){bankerFactory.getJournalReports(cred.org_id,cred.book_id,cred.bank_id).get({description:"USD",action:"before",effective_at:(new Date).toISOString()},function(error,apiRes){if(error)return error;for(var i=0;i<apiRes.posted_lines.length;i++)try{var stringToObj=JSON.parse(apiRes.posted_lines[i].description);apiRes.posted_lines[i].description=stringToObj}catch(e){apiRes.posted_lines[i].description={name:"anonymous",description:apiRes.posted_lines[i].description}}$scope.journal=apiRes.posted_lines,$scope.$digest(),cb&&cb()})},$scope.getJournals(),$scope.withdrawFromBank=function(amount){var userToString={name:$scope.authentication.user.displayName,email:$scope.authentication.user.email,description:"Cash Withdrawal"},userdetails=JSON.stringify(userToString);bankerFactory.createAndPostTransaction(cred.org_id,cred.book_id).createAndPost({effective_at:(new Date).toISOString(),description:userdetails,reference:"http://andonation-mando.herokuapp.com",lines:[{account:cred.bank_id,description:userdetails,reference:"http://andonation-mando.herokuapp.com",value:{type:"debit",amount:amount}},{account:cred.system_id,description:"Cash Deposit",reference:"http://andonation-mando.herokuapp.com",value:{type:"credit",amount:amount}}]},function(error,apiRes){if(error)return error;JSON.parse(apiRes.posting_journal_entry.description);$scope.getBalance(),$scope.getJournals()})},$scope.depositIntoBank=function(amount){var userToString={name:$scope.authentication.user.displayName,email:$scope.authentication.user.email,description:"Cash Deposit"},userdetails=JSON.stringify(userToString);bankerFactory.createAndPostTransaction(cred.org_id,cred.book_id).createAndPost({effective_at:(new Date).toISOString(),description:userdetails,reference:"http://andonation-mando.herokuapp.com",lines:[{account:cred.bank_id,description:userdetails,reference:"http://andonation-mando.herokuapp.com",value:{type:"credit",amount:amount}},{account:cred.system_id,description:"cash deposit",reference:"http://andonation-mando.herokuapp.com",value:{type:"debit",amount:amount}}]},function(error){return error?error:($scope.getBalance(),void $scope.getJournals())})},$scope.openModalWithdraw=function(size){var modalInstance=$modal.open({templateUrl:"modules/banker/views/withdraw.modal.view.html",controller:"modalInstanceCtrl",size:size,resolve:{transaction:function(){return $scope.withdraw}}});modalInstance.result.then(function(amount){$scope.withdrawFromBank(amount),toaster.pop("success","Transaction Completed")})},$scope.openModalDeposit=function(size){var modalInstance=$modal.open({templateUrl:"modules/banker/views/deposit.modal.view.html",controller:"modalInstanceCtrl",size:size,resolve:{transaction:function(){return $scope.deposit}}});modalInstance.result.then(function(amount){$scope.depositIntoBank(amount),toaster.pop("success","Transaction Completed")})}}]),angular.module("banker").controller("modalInstanceCtrl",["$scope","$modalInstance","transaction",function($scope,$modalInstance){$scope.ok=function(transaction){$modalInstance.close(transaction.amount)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}]),angular.module("banker").factory("bankerFactory",["$http",function($http){var subledger=new Subledger,credentials={},setCredentials=function(key_id,secret){subledger.setCredentials(key_id,secret)},getSystemBalance=function(org_id,book_id,account_id){return subledger.organization(org_id).book(book_id).account(account_id)},createAndPostTransaction=function(org_id,book_id){return subledger.organization(org_id).book(book_id).journalEntry()},getJournalReports=function(org_id,book_id,account_id){var org=subledger.organization(org_id),book=org.book(book_id),account=book.account(account_id);return account.line()},getCredentials=function(){return $http.get("/bank/credentials").success(function(data,error){return error?error:void(credentials=data)})};return{getSystemBalance:getSystemBalance,createAndPostTransaction:createAndPostTransaction,getJournalReports:getJournalReports,getCredentials:getCredentials,setCredentials:setCredentials}}]),angular.module("campaign").config(["$stateProvider","datepickerConfig","$sceDelegateProvider",function($stateProvider,datepickerConfig,$sceDelegateProvider){datepickerConfig.startingDay="1",$stateProvider.state("addCampaign",{url:"/campaign/add",templateUrl:"modules/campaigns/views/addCampaign.client.view.html"}).state("editCampaign",{url:"/campaign/:campaignTimestamp/:campaignslug/edit",templateUrl:"modules/campaigns/views/editCampaign.client.view.html"}).state("viewCampaign",{url:"/campaign/:campaignTimeStamp/:campaignslug",templateUrl:"modules/campaigns/views/viewCampaign.client.view.html"}).state("allCampaigns",{url:"/campaigns",templateUrl:"modules/campaigns/views/allCampaigns.client.view.html"}).state("userCampaigns",{resolve:{credentials:["$http",function($http){return $http.get("/bank/credentials")}]},url:"/campaigns/myAndonation",templateUrl:"modules/campaigns/views/userCampaigns.client.view.html",controller:"userCampaignsCtrl"}),$sceDelegateProvider.resourceUrlWhitelist(["**"])}]),angular.module("campaign").controller("addCampaignCtrl",["$scope","toaster","backendService","$location","Authentication","youtubeEmbedUtils",function($scope,toaster,backendService,$location,Authentication,youtubeEmbedUtils){$scope.authentication=Authentication,$scope.campaign={},$scope.minDate=moment().add(1,"days"),$scope.maxDate=moment().add(30,"days"),$scope.authentication.user||$location.path("/"),$scope.addCampaign=function(){$scope.campaign.youtubeUrl=youtubeEmbedUtils.getIdFromURL($scope.campaign.youtubeUrl),backendService.addCampaign($scope.campaign).success(function(data){toaster.pop("success",$scope.campaign.title,"Campaign created successfully"),$location.path("/campaign/"+data.slug)}).error(function(error){$scope.error=error})},$scope.validateYoutubeUrl=function(url,isValid){if(!isValid)return void($scope.youtubeError="Please enter a valid youtube Url");var youtubeId=youtubeEmbedUtils.getIdFromURL(url);return youtubeId===url?void($scope.youtubeError="Please enter a valid youtube URL"):void backendService.checkYouTubeUrl(youtubeId).success(function(){$scope.youtubeError=""}).error(function(error){$scope.youtubeError=error})},$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0}}]),angular.module("campaign").controller("allCampaignCtrl",["$scope","$location","backendService",function($scope,$location,backendService){$scope.Campaigns=[],$scope.criteria="created",$scope.currentPage=1,$scope.itemsPerPage=21,$scope.totalItems=1,$scope.init=function(){backendService.getCampaigns().success(function(data){$scope.campaigns=data,$scope.totalItems=data.length,$scope.filterCampaigns()}).error(function(error){return error})},$scope.filterCampaigns=function(){var begin=($scope.currentPage-1)*$scope.itemsPerPage,end=begin+$scope.itemsPerPage;$scope.startItems=begin+1,$scope.endItems=end<$scope.totalItems?end:$scope.totalItems,$scope.Campaigns=$scope.campaigns.slice(begin,end)},$scope.pageChanged=function(){$scope.filterCampaigns()},$scope.init()}]),angular.module("campaign").controller("editCampaignCtrl",["$scope","toaster","backendService","$location","Authentication","$stateParams","youtubeEmbedUtils",function($scope,toaster,backendService,$location,Authentication,$stateParams,youtubeEmbedUtils){$scope.authentication=Authentication,$scope.authentication.user||$location.path("/"),$scope.getCampaign=function(){backendService.getCampaign($stateParams.campaignTimestamp+"/"+$stateParams.campaignslug).success(function(data){$scope.authentication.user._id!==data.createdBy._id&&$location.path("/campaign/"+data.slug),$scope.minDate=moment(data.created),$scope.maxDate=moment(data.created).add(30,"days"),$scope.campaign=data,$scope.campaign.youtubeUrl="https://www.youtube.com/watch?v="+data.youtubeUrl}).error(function(err){toaster.pop("error","An Error Occurred"+err)})},$scope.getCampaign(),$scope.editCampaign=function(){delete $scope.campaign.createdBy,delete $scope.campaign.created,$scope.campaign.youtubeUrl=youtubeEmbedUtils.getIdFromURL($scope.campaign.youtubeUrl),backendService.updateCampaign($scope.campaign).success(function(data){toaster.pop("success","Campaign Edited Successfully"),$location.path("/campaign/"+data.slug)}).error(function(err){$scope.error=err,toaster.pop("error","An Error Occurred:"+err)})},$scope.validateYoutubeUrl=function(url){var youtubeId=youtubeEmbedUtils.getIdFromURL(url);return youtubeId===url?void($scope.youtubeError="Please enter a valid youtube URL"):void backendService.checkYouTubeUrl(youtubeId).success(function(){$scope.youtubeError=""}).error(function(error){$scope.youtubeError=error})},$scope.deleteCampaign=function(){var confirmMsg=confirm("Do you want to delete this Campaign?");confirmMsg&&backendService.deleteCampaign($scope.campaign._id).success(function(){toaster.pop("success",$scope.campaign.title,"Campaign deleted successfully"),$location.path("/campaigns/myAndonation")}).error(function(){})},$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0}}]),angular.module("campaign").controller("userCampaignsCtrl",["$scope","backendService","toaster","$location","bankerFactory","Authentication","$stateParams","lodash","credentials",function($scope,backendService,toaster,$location,bankerFactory,Authentication,$stateParams,lodash,credentials){$scope.myCampaigns=[],$scope.balance={},$scope.authentication=Authentication,$scope.authentication.user||$location.path("/"),$scope.isAdmin=lodash.findWhere(Authentication.user.roles,{roleType:"admin"})?!0:!1,$scope.isBanker=lodash.findWhere(Authentication.user.roles,{roleType:"banker"})?!0:!1,console.log(credentials);var cred=credentials.data;bankerFactory.setCredentials(cred.key_id,cred.secret_id);var userid=$scope.authentication.user._id;backendService.getUserCampaigns(userid).success(function(myCampaigns){$scope.myCampaigns=myCampaigns}).error(function(){$location.path("/")}),bankerFactory.getSystemBalance(cred.org_id,cred.book_id,cred.bank_id).balance({description:"USD"},function(error,apiRes){if(error)return void toaster.pop("error","An Error Occurred"+error);var amount=parseInt(apiRes.balance.value.amount);$scope.balance.amount=amount,$scope.$digest()}),$scope.limit=4,$scope.increment=function(){var campaignLength=$scope.myCampaigns.length;$scope.limit=campaignLength},$scope.decrement=function(){$scope.limit=4},$scope.getJournals=function(cb){bankerFactory.getJournalReports(cred.org_id,cred.book_id,cred.bank_id).get({description:"USD",action:"before",effective_at:(new Date).toISOString()},function(error,apiRes){if(error)return error;for(var i=0;i<apiRes.posted_lines.length;i++)try{var stringToObj=JSON.parse(apiRes.posted_lines[i].description);apiRes.posted_lines[i].description=stringToObj}catch(e){apiRes.posted_lines[i].description={name:"anonymous",description:apiRes.posted_lines[i].description}}$scope.journal=apiRes.posted_lines,$scope.$digest(),cb&&cb()})},$scope.getJournals()}]),angular.module("campaign").controller("viewCampaignCtrl",["$scope","toaster","backendService","$location","Authentication","$stateParams",function($scope,toaster,backendService,$location,Authentication,$stateParams){$scope.authentication=Authentication,backendService.getCampaign($stateParams.campaignTimeStamp+"/"+$stateParams.campaignslug).success(function(data){console.log(data),$scope.campaign=data}).error(function(error){console.log(error),$location.path("/")})}]),angular.module("campaign").factory("backendService",["$http",function($http){var addCampaign=function(campaignData){return $http.post("/campaign/add",campaignData)},getCampaign=function(campaignid){return $http.get("/campaign/"+campaignid)},deleteCampaign=function(campaignid){return $http["delete"]("/campaign/"+campaignid)},checkYouTubeUrl=function(videoId){return $http.get("//gdata.youtube.com/feeds/api/videos/"+videoId+"?alt=json")},getUserCampaigns=function(userid){return $http.get("/campaigns/"+userid)},getCampaigns=function(){return $http.get("/campaigns")},updateCampaign=function(campaignData){return $http.put("/campaign/"+campaignData._id+"/edit",campaignData)};return{addCampaign:addCampaign,getCampaign:getCampaign,checkYouTubeUrl:checkYouTubeUrl,getUserCampaigns:getUserCampaigns,updateCampaign:updateCampaign,deleteCampaign:deleteCampaign,getCampaigns:getCampaigns}}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication",function($scope,Authentication){$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1})}]),angular.module("core").controller("HomeController",["$scope","Authentication","backendService",function($scope,Authentication,backendService){$scope.authentication=Authentication,$scope.campaigns=[],backendService.getCampaigns().success(function(data){$scope.campaigns=data}).error(function(error){$scope.error=error})}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("/");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]);